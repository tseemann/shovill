name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Perl 5.26
      uses: shogo82148/actions-setup-perl@v1
      with:
        perl-version: '5.26'
    
    - name: Install apt dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pigz unzip libstdc++6 liblzma5 libbz2-1.0 zlib1g-dev
    
    - name: Set up PATH
      run: |
        echo "$PWD/.travis" >> $GITHUB_PATH
        echo "$PWD/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: |
        mkdir -p deps
        cd deps
        source install_deps.sh
        cd ..
    
    - name: Display paths for debugging
      run: |
        pwd
        echo $HOME
        echo $PATH
        find deps -executable -type f
    
    - name: Test kmc
      run: kmc
    
    - name: Test skesa version
      run: skesa --version
    
    - name: Test shovill version
      run: shovill --version
    
    - name: Test shovill check
      run: shovill --check
    
    - name: Test shovill help
      run: shovill --help
    
    - name: Test shovill with invalid option
      run: "! shovill --doesnotexist"
    
    - name: Test shovill with spades assembler
      run: shovill --outdir out.spades --assembler spades --R1 test/R1.fq.gz --R2 test/R2.fq.gz --nostitch --noreadcorr --nocorr
    
    - name: Verify spades output
      run: grep '>' out.spades/contigs.fa
    
    - name: Test shovill with megahit assembler
      run: shovill --outdir out.megahit --assembler megahit --R1 test/R1.fq.gz --R2 test/R2.fq.gz --trim
    
    - name: Verify megahit output
      run: grep '>' out.megahit/contigs.fa
    
    - name: Test shovill with velvet assembler
      run: shovill --outdir out.velvet --assembler velvet --R1 test/R1.fq.gz --R2 test/R2.fq.gz --ram 4 --noreadcorr --nocorr
    
    - name: Verify velvet output
      run: grep '>' out.velvet/contigs.fa
